let o=null,a=null,g=!1,n=null,y="",m=!1,p=null,w=!0;const c=window.location.hostname.includes("chat.openai.com"),P="http://localhost:8000/api/v1";function C(){if(!w)return!1;try{return typeof chrome>"u"?(console.warn("Chrome API not available"),!1):chrome.runtime?chrome.storage?!0:(console.warn("Chrome storage API not available"),!1):(console.warn("Chrome runtime API not available"),!1)}catch(e){return console.warn("Extension context invalid:",e),w=!1,!1}}function v(){console.log("Extension context invalidated, cleaning up..."),w=!1,o&&document.body.contains(o)&&(document.body.removeChild(o),o=null),a&&document.body.contains(a)&&(document.body.removeChild(a),a=null),g=!1,n=null,y="",m=!1,p&&(clearTimeout(p),p=null)}if(typeof chrome<"u"&&chrome.runtime&&chrome.runtime.onSuspend)try{chrome.runtime.onSuspend.addListener(()=>{console.log("Extension suspended, cleaning up..."),v()})}catch(e){console.warn("Could not add suspend listener:",e)}async function B(e,t){if(!C()){console.warn("Extension context invalid, cannot access storage");return}try{return new Promise((i,r)=>{chrome.storage.local.set({[e]:t},()=>{chrome.runtime.lastError?(console.error("Storage error:",chrome.runtime.lastError),r(chrome.runtime.lastError)):i()})})}catch(i){throw console.error("Failed to set storage:",i),v(),i}}async function I(e){if(!C())return console.warn("Extension context invalid, cannot send message"),null;try{return new Promise((t,i)=>{chrome.runtime.sendMessage(e,r=>{chrome.runtime.lastError?(console.error("Runtime message error:",chrome.runtime.lastError),i(chrome.runtime.lastError)):t(r)})})}catch(t){return console.error("Failed to send message:",t),v(),null}}async function L(e){try{console.log("Optimizing prompt:",e.substring(0,50)+"...");const t=await fetch(`${P}/prompt-optimizer/optimize`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({system_prompt:e,context:"",target_audience:"",optimization_focus:["clarity","specificity","completeness"],constraints:""})});if(!t.ok)throw new Error(`API Error: ${t.status}`);const i=await t.json();return console.log("Optimization result received"),i.optimized_prompt||e}catch(t){return console.error("Optimization failed:",t),e}}function x(){const e=['textarea[data-testid="chat-input"]','textarea[data-testid="chat-input-field"]','textarea[data-testid="input"]','textarea[data-testid="text-input"]','textarea[data-testid="message-input"]','textarea[data-id="root"]','textarea[placeholder*="Message ChatGPT"]','textarea[placeholder*="Send a message to ChatGPT"]','textarea[placeholder*="Message"]','textarea[placeholder*="Send a message"]','textarea[placeholder*="Ask me anything"]','textarea[placeholder*="Type your message"]','textarea[placeholder*="Send a message to"]','textarea[placeholder*="Chat"]','textarea[placeholder*="Send"]','textarea[placeholder*="Type"]','textarea[placeholder*="Write"]','textarea[placeholder*="Enter"]','textarea[placeholder*="Input"]','textarea[role="textbox"]','textarea[aria-label*="chat"]','textarea[aria-label*="message"]','textarea[aria-label*="input"]',"textarea"];for(const t of e)try{const i=document.querySelectorAll(t);for(const r of i)if(r.offsetParent!==null&&r.style.display!=="none"&&r.style.visibility!=="hidden"&&r.getBoundingClientRect().width>100&&r.getBoundingClientRect().height>20&&r.getBoundingClientRect().top>0&&r.getBoundingClientRect().left>0)return console.log("Found ChatGPT input with selector:",t,r),r}catch(i){console.warn("Error checking selector:",t,i);continue}return null}function l(){o||(console.log("Button div is null, creating it..."),b());const e=x();if(console.log("Positioning button, found input:",e),e&&c){n=e;const t=e.getBoundingClientRect(),i=56;console.log("Input rect:",t);const r=window.innerWidth,s=window.innerHeight;let d,u;t.right+i+5<=r?(d=t.right+5,u=t.top+t.height/2-i/2):t.left-i-5>=0?(d=t.left-i-5,u=t.top+t.height/2-i/2):t.top-i-5>=0?(d=t.left+t.width/2-i/2,u=t.top-i-5):t.bottom+i+5<=s?(d=t.left+t.width/2-i/2,u=t.bottom+5):(d=t.right-i-10,u=t.top-i-10);const h=10;d=Math.max(h,Math.min(d,r-i-h)),u=Math.max(h,Math.min(u,s-i-h)),Object.assign(o.style,{position:"fixed",left:`${d}px`,top:`${u}px`,zIndex:"999999",display:"flex",visibility:"visible",opacity:"1",animation:"pulse 2s infinite",boxShadow:"0 8px 32px rgba(37, 99, 235, 0.8), 0 0 0 3px rgba(255, 255, 255, 0.5)",transform:"scale(1)",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",filter:"drop-shadow(0 4px 12px rgba(0, 0, 0, 0.4))"}),g=!0,console.log("Button positioned at:",d,u,"near ChatGPT input"),e.style.borderColor="#2563eb",e.style.boxShadow="0 0 0 1px rgba(37, 99, 235, 0.3)",setTimeout(()=>{e&&(e.style.borderColor="",e.style.boxShadow="")},2e3)}else Object.assign(o.style,{position:"fixed",right:"30px",bottom:"30px",zIndex:"999999",display:"flex",visibility:"visible",opacity:"1",boxShadow:"0 8px 32px rgba(37, 99, 235, 0.6), 0 0 0 2px rgba(255, 255, 255, 0.3)",animation:"pulse 2s infinite",transform:"scale(1)",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)"}),g=!0,console.log("Button positioned at fallback location (bottom-right)")}function b(){o||(console.log("Creating floating button..."),o=document.createElement("div"),o.className="prompt-optimizer-button",o.innerHTML=`
    <svg width="28" height="28" viewBox="0 0 24 24" fill="white">
      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
    </svg>
  `,Object.assign(o.style,{width:"56px",height:"56px",background:"linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%)",borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",zIndex:"999999",boxShadow:"0 12px 40px rgba(37, 99, 235, 0.7), 0 0 0 3px rgba(255, 255, 255, 0.4)",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",backdropFilter:"blur(10px)",border:"3px solid rgba(255, 255, 255, 0.5)",outline:"none",animation:"pulse 2s infinite",visibility:"visible",opacity:"1",position:"fixed",transform:"scale(1)",filter:"drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3))"}),o.addEventListener("mouseenter",()=>{o.style.transform="scale(1.15) rotate(5deg)",o.style.boxShadow="0 20px 60px rgba(37, 99, 235, 0.9), 0 0 0 5px rgba(255, 255, 255, 0.7)",o.style.animation="none",o.style.filter="drop-shadow(0 8px 16px rgba(0, 0, 0, 0.4))"}),o.addEventListener("mouseleave",()=>{o.style.transform="scale(1) rotate(0deg)",o.style.boxShadow="0 12px 40px rgba(37, 99, 235, 0.7), 0 0 0 3px rgba(255, 255, 255, 0.4)",o.style.animation="pulse 2s infinite, float 3s ease-in-out infinite",o.style.filter="drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3))"}),o.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),console.log("Floating button clicked!"),G()}),a=document.createElement("div"),a.textContent="Optimize Prompt",Object.assign(a.style,{position:"fixed",background:"linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%)",color:"white",borderRadius:"8px",padding:"8px 16px",fontSize:"12px",fontWeight:"500",boxShadow:"0 4px 20px rgba(37, 99, 235, 0.3)",zIndex:"1000000",cursor:"pointer",display:"none",pointerEvents:"none",whiteSpace:"nowrap"}),o.addEventListener("mouseenter",()=>{if(a){const e=o.getBoundingClientRect();a.style.left=`${e.left+e.width/2}px`,a.style.top=`${e.top-40}px`,a.style.transform="translateX(-50%)",a.style.display="block"}}),o.addEventListener("mouseleave",()=>{a&&(a.style.display="none")}),document.body.appendChild(o),document.body.appendChild(a),console.log("Floating button created and added to page"))}function G(){console.log("handleButtonClick called");let e="";if(c&&n&&(e=n.value,console.log("Got text from ChatGPT input:",e.substring(0,50)+"...")),!e){const t=window.getSelection();t&&t.toString().trim()&&(e=t.toString().trim(),console.log("Got text from selection:",e.substring(0,50)+"..."))}console.log("Final text to optimize:",e),c&&n&&k(),B("selectedText",e).then(()=>{console.log("Text stored in chrome storage"),setTimeout(()=>{I({type:"OPEN_POPUP_WITH_TEXT",text:e}).then(t=>{console.log("Background script response:",t)}).catch(t=>{console.error("Error sending message to background script:",t)})},100)}).catch(t=>{console.error("Error storing text in chrome storage:",t)})}function O(){console.log("=== Button Debug Info ==="),console.log("Button div exists:",!!o),o&&(console.log("Button display:",o.style.display),console.log("Button visibility:",o.style.visibility),console.log("Button opacity:",o.style.opacity),console.log("Button position:",o.style.position),console.log("Button z-index:",o.style.zIndex),console.log("Button rect:",o.getBoundingClientRect()),console.log("Button in DOM:",document.body.contains(o))),console.log("Is visible flag:",g),console.log("========================")}function k(){n&&(n.style.borderColor="#2563eb",n.style.boxShadow="0 0 0 2px rgba(37, 99, 235, 0.2)",setTimeout(()=>{n&&(n.style.borderColor="",n.style.boxShadow="")},2e3))}function M(){var t;if(!n)return;n.style.borderColor="#f59e0b",n.style.boxShadow="0 0 0 2px rgba(245, 158, 11, 0.2)";const e=document.createElement("div");e.textContent="ðŸ”„ Optimizing...",e.style.cssText=`
    position: absolute;
    top: -25px;
    right: 0;
    background: #f59e0b;
    color: white;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    z-index: 1000;
  `,(t=n.parentElement)==null||t.appendChild(e),setTimeout(()=>{e.remove()},3e3)}function S(e){if(!n)return;const t=n.selectionStart;n.selectionEnd,n.value=e,n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0})),n.setSelectionRange(t,t+e.length),n.focus(),n.style.borderColor="#10b981",n.style.boxShadow="0 0 0 2px rgba(16, 185, 129, 0.2)",setTimeout(()=>{n&&(n.style.borderColor="",n.style.boxShadow="")},2e3)}function f(e){if(!c||!n||m)return;const t=e.target.value;t.length>10&&t!==y&&(y=t,p&&clearTimeout(p),p=setTimeout(async()=>{if(t.length>10&&!m){m=!0,M();try{const i=await L(t);i!==t&&(S(i),console.log("Text automatically optimized and replaced"))}catch(i){console.error("Auto-optimization failed:",i)}finally{m=!1}}},2e3))}function _(){const e=document.createElement("style");e.textContent=`
    @keyframes pulse {
      0%, 100% { 
        transform: scale(1);
        box-shadow: 0 12px 40px rgba(37, 99, 235, 0.7), 0 0 0 3px rgba(255, 255, 255, 0.4);
      }
      50% { 
        transform: scale(1.08);
        box-shadow: 0 16px 50px rgba(37, 99, 235, 0.8), 0 0 0 4px rgba(255, 255, 255, 0.6);
      }
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-3px); }
    }
    
    .prompt-optimizer-button {
      animation: pulse 2s infinite, float 3s ease-in-out infinite;
    }
    
    .prompt-optimizer-button:hover {
      animation: none;
      transform: scale(1.15) rotate(5deg);
      box-shadow: 0 20px 60px rgba(37, 99, 235, 0.9), 0 0 0 5px rgba(255, 255, 255, 0.7);
    }
  `,document.head.appendChild(e)}function z(){if(!c)return;console.log("Starting ChatGPT input monitoring..."),new MutationObserver(()=>{const s=x();s&&s!==n&&(console.log("New ChatGPT input found"),n=s,n.removeEventListener("input",f),n.addEventListener("input",f),l())}).observe(document.body,{childList:!0,subtree:!0}),setInterval(()=>{const s=x();s&&s!==n&&(console.log("New ChatGPT input found via interval"),n=s,n.removeEventListener("input",f),n.addEventListener("input",f),l())},1e3);let t=0;const i=10,r=()=>{const s=x();s?(console.log("Initial ChatGPT input found"),n=s,n.addEventListener("input",f),l()):t<i&&(t++,setTimeout(r,500))};setTimeout(r,1e3)}function T(){console.log("Content script initializing...");try{b(),_(),o&&(o.style.display="flex",o.style.visibility="visible",o.style.opacity="1",console.log("Button created and made visible")),setTimeout(()=>{try{l()}catch(e){console.error("Error positioning button:",e)}},100),setTimeout(()=>{if(o)try{l(),console.log("Button repositioned after 1s")}catch(e){console.error("Error repositioning button after 1s:",e)}},1e3),setTimeout(()=>{if(o)try{l(),console.log("Button repositioned after 2s")}catch(e){console.error("Error repositioning button after 2s:",e)}},2e3),setTimeout(()=>{if(o)try{l(),console.log("Button repositioned after 5s")}catch(e){console.error("Error repositioning button after 5s:",e)}},5e3),window.addEventListener("resize",()=>{if(o&&g)try{l()}catch(e){console.error("Error repositioning button on resize:",e)}}),window.addEventListener("scroll",()=>{if(o&&g)try{l()}catch(e){console.error("Error repositioning button on scroll:",e)}}),c&&z(),console.log("Content script initialized")}catch(e){console.error("Error initializing content script:",e)}}chrome.runtime.onMessage.addListener((e,t,i)=>{if(console.log("Content script received message:",e),e.type==="GET_SELECTED_TEXT"){let r="";if(c&&n&&(r=n.value,console.log("Got text from ChatGPT input:",r.substring(0,50)+"...")),!r){const s=window.getSelection();s&&s.toString().trim()&&(r=s.toString().trim(),console.log("Got text from selection:",r.substring(0,50)+"..."))}console.log("Sending selected text:",r.substring(0,50)+"..."),i({text:r})}if(e.type==="GET_CHATGPT_TEXT"){let r="";c&&n&&(r=n.value,console.log("Sending ChatGPT text:",r.substring(0,50)+"...")),i({text:r})}if(e.type==="REPLACE_CHATGPT_TEXT"){const r=e.text||"";console.log("Replacing ChatGPT text with:",r.substring(0,50)+"..."),c&&n?(S(r),i({success:!0})):i({success:!1,error:"ChatGPT input not found"})}});document.readyState==="loading"?document.addEventListener("DOMContentLoaded",T):T();document.addEventListener("keydown",e=>{e.ctrlKey&&e.shiftKey&&e.key==="B"&&(console.log("Debug shortcut pressed"),O(),o||b(),o&&(o.style.display="flex",o.style.visibility="visible",o.style.opacity="1",o.style.transform="scale(1.2)",o.style.boxShadow="0 12px 40px rgba(37, 99, 235, 0.8)",l(),setTimeout(()=>{o&&(o.style.transform="scale(1)",o.style.boxShadow="0 8px 32px rgba(37, 99, 235, 0.6), 0 0 0 2px rgba(255, 255, 255, 0.3)")},2e3)))});let E=window.location.href;const A=new MutationObserver(()=>{window.location.href!==E&&(E=window.location.href,setTimeout(()=>{console.log("URL changed, reinitializing..."),b(),l(),c&&z()},1e3))});A.observe(document.body,{childList:!0,subtree:!0});
