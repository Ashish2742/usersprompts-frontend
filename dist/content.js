let t=null,s=null,a=null;const r=window.location.hostname.includes("chat.openai.com");function u(){const e=['textarea[data-id="root"]','textarea[data-testid="chat-input"]','textarea[data-testid="chat-input-field"]','textarea[data-testid="input"]','textarea[data-testid="text-input"]','textarea[data-testid="message-input"]','textarea[placeholder*="Message"]','textarea[placeholder*="Send a message"]','textarea[placeholder*="Message ChatGPT"]','textarea[placeholder*="Send a message to ChatGPT"]','textarea[placeholder*="Ask me anything"]','textarea[placeholder*="Type your message"]','textarea[placeholder*="Send a message to"]','textarea[placeholder*="Message"]','textarea[placeholder*="Chat"]','textarea[placeholder*="Send"]','textarea[placeholder*="Type"]','textarea[placeholder*="Write"]','textarea[placeholder*="Enter"]','textarea[placeholder*="Input"]','textarea[role="textbox"]','textarea[aria-label*="chat"]','textarea[aria-label*="message"]','textarea[aria-label*="input"]',"textarea"];for(const o of e){const l=document.querySelectorAll(o);for(const n of l)if(n.offsetParent!==null&&n.style.display!=="none"&&n.style.visibility!=="hidden"&&n.getBoundingClientRect().width>100&&n.getBoundingClientRect().height>20)return console.log("Found ChatGPT input with selector:",o,n),n}return null}function c(){if(!t)return;const e=u();if(console.log("Positioning button, found input:",e),e&&r){a=e;const o=e.getBoundingClientRect(),l=48;console.log("Input rect:",o);const n=window.innerWidth,i=window.innerHeight;let p=o.right+10,d=o.top+o.height/2-l/2;p+l>n-20&&(p=o.left-l-10),d<20?d=20:d+l>i-20&&(d=i-l-20),t.style.position="fixed",t.style.left=`${p}px`,t.style.top=`${d}px`,t.style.zIndex="999999",t.style.display="flex",t.style.animation="pulse 2s infinite",console.log("Button positioned at:",p,d)}else t.style.position="fixed",t.style.right="20px",t.style.bottom="20px",t.style.zIndex="999999",t.style.display="flex",console.log("Button positioned at fallback location")}function x(){t||(console.log("Creating floating button..."),t=document.createElement("div"),t.innerHTML=`
    <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
    </svg>
  `,Object.assign(t.style,{width:"48px",height:"48px",background:"linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%)",borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",zIndex:"999999",boxShadow:"0 8px 32px rgba(37, 99, 235, 0.4)",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",backdropFilter:"blur(10px)",border:"2px solid rgba(255, 255, 255, 0.2)",outline:"none",animation:"pulse 2s infinite"}),t.addEventListener("mouseenter",()=>{t.style.transform="scale(1.15) rotate(5deg)",t.style.boxShadow="0 12px 40px rgba(37, 99, 235, 0.5)",t.style.animation="none"}),t.addEventListener("mouseleave",()=>{t.style.transform="scale(1) rotate(0deg)",t.style.boxShadow="0 8px 32px rgba(37, 99, 235, 0.4)",t.style.animation="pulse 2s infinite"}),t.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),console.log("Floating button clicked!"),m()}),s=document.createElement("div"),s.textContent="Optimize Prompt",Object.assign(s.style,{position:"fixed",background:"linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%)",color:"white",borderRadius:"8px",padding:"8px 16px",fontSize:"12px",fontWeight:"500",boxShadow:"0 4px 20px rgba(37, 99, 235, 0.3)",zIndex:"1000000",cursor:"pointer",display:"none",pointerEvents:"none",whiteSpace:"nowrap"}),t.addEventListener("mouseenter",()=>{if(s){const e=t.getBoundingClientRect();s.style.left=`${e.left+e.width/2}px`,s.style.top=`${e.top-40}px`,s.style.transform="translateX(-50%)",s.style.display="block"}}),t.addEventListener("mouseleave",()=>{s&&(s.style.display="none")}),document.body.appendChild(t),document.body.appendChild(s),console.log("Floating button created and added to page"))}function m(){console.log("handleButtonClick called");let e="";if(r&&a&&(e=a.value,console.log("Got text from ChatGPT input:",e.substring(0,50)+"...")),!e){const o=window.getSelection();o&&o.toString().trim()&&(e=o.toString().trim(),console.log("Got text from selection:",e.substring(0,50)+"..."))}console.log("Final text to optimize:",e),r&&a&&b(),chrome.storage.local.set({selectedText:e},()=>{console.log("Text stored in chrome storage"),chrome.runtime.sendMessage({type:"OPEN_POPUP_WITH_TEXT",text:e},o=>{console.log("Background script response:",o)})})}function b(){a&&(a.style.borderColor="#2563eb",a.style.boxShadow="0 0 0 2px rgba(37, 99, 235, 0.2)",setTimeout(()=>{a&&(a.style.borderColor="",a.style.boxShadow="")},2e3))}function y(){const e=document.createElement("style");e.textContent=`
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    .prompt-optimizer-button {
      animation: pulse 2s infinite;
    }
  `,document.head.appendChild(e)}function f(){if(!r)return;console.log("Starting ChatGPT input monitoring..."),new MutationObserver(()=>{const i=u();i&&i!==a&&(console.log("New ChatGPT input found"),a=i,c())}).observe(document.body,{childList:!0,subtree:!0}),setInterval(()=>{const i=u();i&&(a=i,c())},1e3);let o=0;const l=10,n=()=>{const i=u();i?(console.log("Initial ChatGPT input found"),a=i,c()):o<l&&(o++,setTimeout(n,500))};setTimeout(n,1e3)}function g(){console.log("Content script initializing..."),x(),y(),setTimeout(()=>{c()},500),r&&f(),console.log("Content script initialized")}chrome.runtime.onMessage.addListener((e,o,l)=>{if(console.log("Content script received message:",e),e.type==="GET_SELECTED_TEXT"){let n="";if(r&&a&&(n=a.value),!n){const i=window.getSelection();i&&i.toString().trim()&&(n=i.toString().trim())}console.log("Sending selected text:",n.substring(0,50)+"..."),l({text:n})}});document.readyState==="loading"?document.addEventListener("DOMContentLoaded",g):g();let h=window.location.href;const w=new MutationObserver(()=>{window.location.href!==h&&(h=window.location.href,setTimeout(()=>{console.log("URL changed, reinitializing..."),x(),c(),r&&f()},1e3))});w.observe(document.body,{childList:!0,subtree:!0});
